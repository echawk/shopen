#!/bin/sh

# shopen - a POSIX shell replacement for xdg-open
# Copyright (c) 2021, Ethan Hawk
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# SPDX-License-Identifier: GPL-3.0-or-later


SYSTEM_DESKTOP_FILES_DIR=/usr/share/applications/
USER_DESKTOP_FILES_DIR=$HOME/.local/share/applications/
MIMEAPPSLIST=${XDG_CONFIG_DIR:-$HOME/.config}/mimeapps.list
REGEXRULESFILE=${XDG_CONFIG_DIR:-$HOME/.config}/shopen/rerules.tsv
MIMERULESFILE=${XDG_CONFIG_DIR:-$HOME/.config}/shopen/mimerules.tsv
# depends: file, grep, cut, sed

for f in "$@"
do
	WANTDESKTOPFILE=""
	DESKTOPFILE=""
	MIME_TYPE="$(file --mime-type "$f" | cut -d':' -f2 | sed "s/^ //")"

	[ -z "$MIME_TYPE" ] && {
	[ -e "$MIMERULESFILE" ] && {
		#TODO: replace with a while-read loop
		for mirule in $(grep -v -E "(^#|^$)"  "$MIMERULESFILE" | cut -d'	' -f1)
		do
			if printf "%s" "$MIME_TYPE" | grep -q -E "$mirule"
			then
				execcmd=$(grep -F "${mirule}" "$MIMERULESFILE" | cut -d'	' -f2 | sed "s~%M~\"${f}\"~g")
				break
			fi
		done
	}
	}

	[ -z "$execcmd" ] && {
	if grep -q "$MIME_TYPE" "$MIMEAPPSLIST"
	then
		WANTDESKTOPFILE=$(grep "$MIME_TYPE" "$MIMEAPPSLIST" | cut -d'=' -f2)
	fi

	# Look in USER_DESKTOP_FILES_DIR first
	for deskf in "$USER_DESKTOP_FILES_DIR"*
	do
		# if we found the desktop file, save the location
		# and break the loop
		#if echo $deskf | grep -q $WANTDESKTOPFILE
		if [ "${deskf##*/}" = "$WANTDESKTOPFILE" ]
		then
			DESKTOPFILE="$(echo "$deskf" | grep "$WANTDESKTOPFILE")"
			break
		fi
	done

	# Now look into SYSTEM_DESKTOP_FILES_DIR

	# Only search if we didn't find it in the users desktop file
	# directory

	[ -z "$DESKTOPFILE" ] && {
		for deskf in "$SYSTEM_DESKTOP_FILES_DIR"*
		do
			#if echo $deskf | grep -q $WANTDESKTOPFILE
			if [ "${deskf##*/}" = "$WANTDESKTOPFILE" ]
			then
				DESKTOPFILE="$(echo "$deskf" | grep "$WANTDESKTOPFILE")"
				break
			fi
		done
	}

	# if we still havent found the proper desktop file, we now need to search for
	# a desktop file that can handle the proper mimetype

	# First check the user directory
	[ -z "$DESKTOPFILE" ] && {
		for deskf in "$USER_DESKTOP_FILES_DIR"*
		do
			if grep -q "$MIME_TYPE" "$deskf"
			then
				DESKTOPFILE="$deskf"
				break
			fi
		done
	}

	# now check the system directory
	[ -z "$DESKTOPFILE" ] && {
		for deskf in "$SYSTEM_DESKTOP_FILES_DIR"*
		do
			if grep -q "$MIME_TYPE" "$deskf"
			then
				DESKTOPFILE="$deskf"
				break
			fi
		done
	}
		# open the file according to how the desktop file specifies
		execcmd="$(grep "^Exec=" "$DESKTOPFILE" | sed "s~%[fFuU]~\"$f\"~")"
		execcmd="${execcmd#*=}"
	}

	# this file is a tab separated file, with the first collumn being
	# the regular expression, and the second column being the command
	# to run. '%M' is replaced with '$f'. This is so that commands
	# can be arbitrarily complex.
	[ -z "$execcmd" ] && {
		[ -e "$REGEXRULESFILE" ] && {
			#TODO: replace with a while-read loop
			for rerule in $(grep -v -E "(^#|^$)"  "$REGEXRULESFILE" | cut -d'	' -f1)
			do
				if printf "%s" "$f" | grep -q -E "$rerule"
				then
					execcmd=$(grep -F "${rerule}" "$REGEXRULESFILE" | cut -d'	' -f2 | sed "s~%M~\"${f}\"~g")
					break
				fi
			done
		}
	}

	# we use 'sh' here instead of 'exec' because it will transfer our current environment
	sh -c "$execcmd" &

done
wait
